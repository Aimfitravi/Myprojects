package com.shopx.service;

import java.io.File;
import java.io.IOException;

import javax.annotation.PostConstruct;

import org.apache.commons.io.FileUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import com.app.custom_exceptions.ResourceNotFoundException;
import com.app.dao.EmployeeDao;
import com.app.dto.ApiResponse;
import com.app.entities.Employee;
import com.shopx.dao.ProductDao;

@Service
@Transactional
public class ImageHandlingServiceImpl implements ImageHandlingService {
	//dep:emp dao i/f
	@Autowired
	private ProductDao productDao;
	
	//to inject the value of a property : "upload.location", from app property file
	//Filed level DI, for injecting the value: using SpEL (Spring expression language)
	@Value("${upload.location}")
	private String folderLocation;
	
	@PostConstruct
	public void init() {
		System.out.println("in init"+folderLocation);
		//check if folder exists
		File folder=new File(folderLocation);
		if(folder.exists())
			System.out.println("folder already exists");
		else {
			folder.mkdir();//creates a new folder
		System.out.println("created a new folder...");	
		}
	}
	
	@Override
	public String uploadImage(Long empId, MultipartFile file) throws IOException {
		//check if emp exists by id
		Employee emp=empDao.findById(empId).orElseThrow(()->new ResourceNotFoundException("Invalid emp id!!"));
			//emp: persistent
		//save uploaded file contents in server side folder.
		String path=folderLocation.concat(file.getOriginalFilename());
		System.out.println("path "+path);
		//FileUtils class : to read byte[] from multipart file---> server side folder
		//API; public void writeByteArrayToFile(File file, byte[] data) throws IOException
		FileUtils.writeByteArrayToFile(new File(path), file.getBytes());
		emp.setImagePath(path);
		
		return new String("File uploaded and stord in server side folder");
	}

}
